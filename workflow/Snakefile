import os
import pandas as pd
from scripts.libraries import js


configfile: 'config/config.yaml'

folder = os.path.abspath('.')
fasta_folder = "data/omm_NT_fasta.v10c_116"
tree_folder = "data/omm_RooTree.v10b_116"
xml_folder = "data/omm_markers"

bayescode_path = {}

for executable in ["mutselomega", "readmutselomega"]:
    exec_path = os.path.join(folder, f'utils/BayesCode/bin/{executable}')
    if not os.path.exists(exec_path):
        # Find executable in the path using whereis. If not found, raise an error.
        split = os.popen(f'whereis {executable}').read().split()
        if len(split) > 1:
            exec_path = split[1].strip()
        else:
            raise FileNotFoundError(f'{executable} not found. Please install BayesCode and add it to your path.')
    bayescode_path[executable] = exec_path
    print(f"Found {executable} at {exec_path}")

# Filter genes
genes_summary = pd.read_csv("data/genes_summary.csv", header=0, index_col=None)
print(f"Looking at {len(genes_summary)} genes...")
genes_summary = genes_summary[(genes_summary['s1_length'] >= 1) & (genes_summary['s2_length'] >= 1) &
                              (genes_summary['s1_species'] >= 20) & (genes_summary['s2_species'] >= 20)]
print(f"Found {len(genes_summary)} genes with a tree length of at least 1 and at least 20 species in each subset...")
CDS_list = genes_summary['gene'].tolist()[config['CDS_start']:config['CDS_end']]
print(f"Using {len(CDS_list)} genes.")

models = {"sitemutsel": "--ncat 30",
          "siteomega": "--freeomega --omegancat 30 --flatfitness"}

points = config['points']
burn_in = config['burn_in']


localrules: all,subset

rule all:
    input:
        expand("processed/{CDS}/distance.tsv", CDS=CDS_list)

rule subset:
    input:
        script = "workflow/scripts/subset.py",
        fasta = "data/omm_NT_fasta.v10c_116/{CDS}_NT.fasta",
        tree = "data/omm_RooTree.v10b_116/{CDS}_NT.rootree",
        clade = "data/clades/Glires.tsv",
    output:
        expand("processed/{{CDS}}/Glires.{subset}.phy", subset=["Include", "Exclude"]),
        expand("processed/{{CDS}}/Glires.{subset}.rootree", subset=["Include", "Exclude"])
    shell:
        "python3 {input.script} --fasta {input.fasta} --tree {input.tree} --subset {input.clade} --outdir {folder}/processed/{wildcards.CDS}/Glires"

rule run_bayescode:
    input:
        bin = bayescode_path['mutselomega'],
        phy = "processed/{CDS}/Glires.{subset}.phy",
        tree = "processed/{CDS}/Glires.{subset}.rootree",
    output:
        "processed/{CDS}/Glires.{subset}.chain"
    params:
        time="3-23:00",mem=1000,threads=1,name=lambda wildcards: wildcards.CDS,
    shell:
        "{input.bin} -a {input.phy} -t {input.tree} -u 2000 {folder}/processed/{wildcards.CDS}/Glires.{wildcards.subset}"

rule read_bayescode:
    input:
        bin = bayescode_path['readmutselomega'],
        chain = "processed/{CDS}/Glires.{subset}.chain",
    params:
        time="0-10:00",mem=1000,threads=1,name=lambda wildcards: wildcards.CDS,
    output:
        "processed/{CDS}/{subset}.siteprofiles"
    shell:
        "{input.bin} --every 1 --until 2000 --burnin 1000 --ss {folder}/processed/{wildcards.CDS}/Glires.{wildcards.subset}"

# pour un gène, expand pour tout les modèles
rule distance:
    input:
        expand("processed/{{CDS}}/{subset}.siteprofiles", subset=["Include", "Exclude"])
    output:
        "processed/{CDS}/distance.tsv"
    run:
        df1 = pd.read_csv(input[0],sep="\t",header=0,index_col=0)
        df2 = pd.read_csv(input[1],sep="\t",header=0,index_col=0)
        distance = js(df1, df2)
        distance.to_csv(output, sep="\t")